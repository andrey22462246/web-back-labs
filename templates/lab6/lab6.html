{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block script %}
<style>
.office-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    font-family: Arial, sans-serif;
}

.page-title {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #7f8c8d;
    text-align: center;
    margin-bottom: 30px;
}

.office-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.office-item {
    background: white;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.office-item:hover {
    border-color: #3498db;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
}

.office-info {
    flex-grow: 1;
}

.office-number {
    font-weight: bold;
    color: #2c3e50;
    font-size: 1.2em;
}

.office-status {
    color: #7f8c8d;
    margin: 5px 0;
}

.office-price {
    color: #27ae60;
    font-weight: bold;
}

.office-actions {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-book {
    background: #3498db;
    color: white;
}

.btn-book:hover {
    background: #2980b9;
}

.btn-release {
    background: #e74c3c;
    color: white;
}

.btn-release:hover {
    background: #c0392b;
}

.total-cost {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    margin-top: 30px;
    font-weight: bold;
    font-size: 1.1em;
}

.status-free {
    color: #27ae60;
    font-weight: bold;
}

.status-occupied {
    color: #e74c3c;
    font-weight: bold;
}

.loading {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 40px;
}
</style>

<script>
function getOfficeList(){
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random()*1000)
    };
    
    const ul = document.getElementById('office-list');
    ul.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ—Ñ–∏—Å–æ–≤...</div>';
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response){
        return response.json()
    })
    .then(function(data) {
        console.log('Office data:', data);
        const office_list = data.result;
        const ul = document.getElementById('office-list');
        ul.innerHTML = '';
        
        for(let i = 0; i < office_list.length; i++) {
            const office = office_list[i];
            const li = document.createElement('li');
            li.className = 'office-item';
            
            li.innerHTML = `
                <div class="office-info">
                    <div class="office-number">–û—Ñ–∏—Å ${office.number}</div>
                    <div class="office-status">
                        –°—Ç–∞—Ç—É—Å: <span class="${office.tenant ? 'status-occupied' : 'status-free'}">
                            ${office.tenant || '–°–≤–æ–±–æ–¥–µ–Ω'}
                        </span>
                    </div>
                    <div class="office-price">${office.price} —Ä—É–±./–º–µ—Å.</div>
                </div>
                <div class="office-actions">
                    <button class="btn btn-book" onclick="booking(${office.number})">
                        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-release" onclick="release(${office.number})">
                        –û—Å–≤–æ–±–æ–¥–∏—Ç—å
                    </button>
                </div>
            `;
            ul.appendChild(li);
        }
        
        updateTotalCost();
    })
    .catch(function(error) {
        console.error('Error:', error);
        document.getElementById('office-list').innerHTML = '<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ñ–∏—Å–æ–≤</div>';
    });
}

function updateTotalCost() {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'my_offices',
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response){
        return response.json()
    })
    .then(function(data) {
        const totalElement = document.getElementById('total-cost');
        if (data.result.count > 0) {
            totalElement.innerHTML = `
                <div class="total-cost">
                    üíº –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–∏—Ö –æ—Ñ–∏—Å–æ–≤: <strong>${data.result.total_cost} —Ä—É–±./–º–µ—Å.</strong><br>
                    <small>–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ –æ—Ñ–∏—Å–æ–≤: ${data.result.count}</small>
                </div>
            `;
        } else {
            totalElement.innerHTML = `
                <div class="total-cost">
                    üè¢ –£ –≤–∞—Å –Ω–µ—Ç –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤
                </div>
            `;
        }
    });
}

function booking(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'booking',
        'params': officeNumber,
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error.message);
        } else {
            getOfficeList();
        }
    });
}

function release(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'release',
        'params': officeNumber,
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + data.error.message);
        } else {
            getOfficeList();
        }
    });
}

document.addEventListener('DOMContentLoaded', function(){
    getOfficeList();
});
</script>
{% endblock %}

{% block main %}
<div class="office-container">
    <h1 class="page-title">API JSON-RPC</h1>
    <div class="page-subtitle">
        –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6 - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥–æ–π –æ—Ñ–∏—Å–æ–≤
    </div>
    
    <h2>–°–ø–∏—Å–æ–∫ –æ—Ñ–∏—Å–æ–≤</h2>
    <ul class="office-list" id="office-list"></ul>
    
    <div id="total-cost"></div>
</div>
{% endblock %}