{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block script %}
<script>
const styles = `
    .office-container { max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; border-radius: 10px; }
    .page-title { color: #2c3e50; text-align: center; margin-bottom: 10px; }
    .page-subtitle { color: #666; text-align: center; margin-bottom: 30px; }
    .office-list { list-style: none; padding: 0; }
    .office-item { 
        background: white; 
        border: 2px solid #ddd; 
        border-radius: 8px; 
        margin-bottom: 10px; 
        padding: 15px; 
        display: flex; 
        justify-content: space-between;
        align-items: center;
    }
    .office-item:hover { border-color: #3498db; }
    .office-info { flex-grow: 1; }
    .office-number { font-weight: bold; color: #2c3e50; }
    .office-status { color: #666; margin: 5px 0; }
    .office-price { color: #27ae60; font-weight: bold; }
    .office-actions { display: flex; gap: 10px; }
    .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-book { background: #3498db; color: white; }
    .btn-release { background: #e74c3c; color: white; }
    .total-cost { 
        background: #2c3e50; 
        color: white; 
        padding: 15px; 
        border-radius: 8px; 
        text-align: center; 
        margin-top: 20px; 
        font-weight: bold;
    }
    .status-free { color: #27ae60; }
    .status-occupied { color: #e74c3c; }
`;

const styleSheet = document.createElement("style");
styleSheet.innerText = styles;
document.head.appendChild(styleSheet);

function getOfficeList(){
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response){
        return response.json()
    })
    .then(function(data) {
        const office_list = data.result;
        const ul = document.getElementById('office-list');
        ul.innerHTML = '';
        
        for(let i = 0; i < office_list.length; i++) {
            const office = office_list[i];
            const li = document.createElement('li');
            li.className = 'office-item';
            
            li.innerHTML = `
                <div class="office-info">
                    <div class="office-number">–û—Ñ–∏—Å ${office.number}</div>
                    <div class="office-status">
                        –°—Ç–∞—Ç—É—Å: <span class="${office.tenant ? 'status-occupied' : 'status-free'}">
                            ${office.tenant || '–°–≤–æ–±–æ–¥–µ–Ω'}
                        </span>
                    </div>
                    <div class="office-price">${office.price} —Ä—É–±./–º–µ—Å.</div>
                </div>
                <div class="office-actions">
                    <button class="btn btn-book" onclick="booking(${office.number})">
                        –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-release" onclick="release(${office.number})">
                        –û—Å–≤–æ–±–æ–¥–∏—Ç—å
                    </button>
                </div>
            `;

            ul.appendChild(li);
        }
        
        updateTotalCost();
    });
}

function updateTotalCost() {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'my_offices',
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response){
        return response.json()
    })
    .then(function(data) {
        const totalElement = document.getElementById('total-cost');
        if (data.result.count > 0) {
            totalElement.innerHTML = `
                <div class="total-cost">
                    üíº –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–∏—Ö –æ—Ñ–∏—Å–æ–≤: ${data.result.total_cost} —Ä—É–±./–º–µ—Å.<br>
                    <small>–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ –æ—Ñ–∏—Å–æ–≤: ${data.result.count}</small>
                </div>
            `;
        } else {
            totalElement.innerHTML = `
                <div class="total-cost">
                    üè¢ –£ –≤–∞—Å –Ω–µ—Ç –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤
                </div>
            `;
        }
    });
}

function booking(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'booking',
        'params': officeNumber,
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + (data.error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        } else {
            getOfficeList();
        }
    });
}

function release(officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'release',
        'params': officeNumber,
        'id': Math.round(Math.random()*1000)
    };
    
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if (data.error) {
            alert('–û—à–∏–±–∫–∞: ' + (data.error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        } else {
            getOfficeList();
        }
    });
}

document.addEventListener('DOMContentLoaded', function(){
    getOfficeList();
});
</script>
{% endblock %}

{% block main %}
<div class="office-container">
    <h1 class="page-title">API JSON-RPC</h1>
    <div class="page-subtitle">
        –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6 - –°–∏—Å—Ç–µ–º–∞ –∞—Ä–µ–Ω–¥—ã –æ—Ñ–∏—Å–æ–≤
    </div>
    
    <h2>–°–ø–∏—Å–æ–∫ –æ—Ñ–∏—Å–æ–≤</h2>
    <ul class="office-list" id="office-list"></ul>
    
    <div id="total-cost"></div>
</div>
{% endblock %}